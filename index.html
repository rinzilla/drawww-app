<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="telegram-web-app-bot-integration" content="true">
    <title>Telegram Рисовалка</title>
    <style>
        body { margin:0; padding:0; overflow:hidden; background:#fff; }
        canvas { display:block; width:100vw; height:100vh; touch-action:none; }
        .controls { position:fixed; bottom:20px; left:0; right:0; display:flex; justify-content:center; gap:15px; }
        button { padding:12px 25px; background:#0088cc; color:#fff; border:none; border-radius:25px; font-size:16px; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div class="controls">
        <button id="clear">Очистить</button>
        <button id="save">Сохранить</button>
    </div>

    <script>
        // Проверка окружения Telegram
        const isTelegram = () => {
            return window.Telegram && Telegram.WebApp && Telegram.WebApp.initData;
        };

        // Блокировка открытия вне Telegram
        if (!isTelegram()) {
            document.body.innerHTML = `
                <div style="padding:20px;text-align:center;">
                    <h2>Откройте через Telegram-бота</h2>
                    <p>Эта рисовалка работает только внутри Telegram</p>
                </div>
            `;
            throw new Error("Not in Telegram");
        }

        // Инициализация WebApp
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.setHeaderColor("#0088cc");
        Telegram.WebApp.setBackgroundColor("#ffffff");

        // Настройка Canvas
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;
        
        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            ctx.lineJoin = ctx.lineCap = 'round';
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#000';
        }

        // Плавное рисование
        function draw(e) {
            if (!drawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        // Обработчики событий
        canvas.addEventListener('mousedown', (e) => {
            drawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        });

        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mouseout', () => drawing = false);

        // Для сенсорных устройств
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            drawing = true;
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchend', () => drawing = false);

        // Кнопки управления
        document.getElementById('clear').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        document.getElementById('save').addEventListener('click', () => {
            canvas.toBlob(blob => {
                const reader = new FileReader();
                reader.onload = () => {
                    Telegram.WebApp.sendData(reader.result);
                    Telegram.WebApp.close();
                };
                reader.readAsDataURL(blob);
            }, 'image/png', 0.9);
        });

        // Инициализация
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    </script>
</body>
</html>
